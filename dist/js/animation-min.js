define(["jquery","underscore"],function(a,b){function c(){this.builtinCommands={}}function d(){var c,d=this,e=[];d.register("on",function(a){var b=a.param,d=a.node,f=a.done,g=a.index;l.indexOf(b)>-1&&d.on(b,function(){clearTimeout(c),console.log(e),e.forEach(function(a,b){d.removeClass(a)}),e=[],f(g)})}),d.register("emit",function(a){var b=a.param,c=(a.node,a.done);m[b].done(),c()}),d.register("class",function(a){function b(a){i||(i=!0,"2"!==k&&(d.removeClass(j),e.splice(e.indexOf(j),1)),h())}var c=a.param,d=a.node,h=a.done,i=!1,j=c.split(",")[0],k=c.split(",")[1];d.addClass(j),e.push(j),d.off(g+".bxAnimation"),d.off(f+".bxAnimation"),"3"===k?h():(d.on(g+".bxAnimation",b),d.on(f+".bxAnimation",b))}),d.register("wait",function(a){var b=(a.node,a.param),d=a.done;c=setTimeout(function(){d()},b)}),d.register("style",function(c){function d(a){l||(l=!0,"2"!==e&&b.each(k,function(a,b){h.css(a.name,"")}),i())}var e,h=c.node,i=c.done,j=c.param.split(","),k=[],l=!1;/\s+/.test(a.trim(j[j.length-1]))||(e=a.trim(j.pop())),b.each(j,function(b,c){b=a.trim(b);var d=b.split(/\s+/);k.push({name:d.shift(),value:d.join(" ")})}),b.each(k,function(a,b){h.css(a.name,a.value)}),h.off(g+".bxAnimation"),h.off(f+".bxAnimation"),"3"===e?i():(h.on(f+".bxAnimation",d),h.on(g+".bxAnimation",d))})}function e(b){function c(c,e){var f=a.trim(c),g=a.trim(f.split(":")[0]),h=a.trim(f.split(":")[1]),i={command:g,node:b,index:e,param:h,done:function(a){var b=a||e;d(++b)}};return i}function d(a){if(a>f.length-1)return void(a=0);var b=c(f[a],a),d=e.builtinCommands[b.command];if(!d)throw b.command+" 该命令未定义";setTimeout(function(){d(b,{})},0)}var e=this,f=b.attr("bx-animation").split(";");""===a.trim(f[f.length-1])&&f.pop(),f.forEach(function(a,b){var d=c(a,b);"on"===d.command&&-1===l.indexOf(d.param)&&(m[d.param]=d)}),d(0)}var f="transitionend",g="animationend",h="transition",i="animation";"ontransitionend"in window||("onwebkittransitionend"in window?(f+=" webkitTransitionEnd",h="webkitTransition"):("onotransitionend"in dom.tNode||"Opera"===navigator.appName)&&(f+=" oTransitionEnd",h="oTransition")),"onanimationend"in window||("onwebkitanimationend"in window?(g+=" webkitAnimationEnd",i="webkitAnimation"):"onoanimationend"in dom.tNode&&(g+=" oAnimationEnd",i="oAnimation"));var j,k=document.createElement("div"),l=[];for(j in k)/^on/.test(j)&&l.push(j.slice(2));var m={};return c.prototype={boot:function(){var c=this;d.call(c);var f=a("[bx-animation]");b.each(f,function(b,d){e.call(c,a(b))})},register:function(a,b){this.builtinCommands[a]=b}},c});